<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Markdown Formatter and Link Extractor</title>
    <style>
        #inputMarkdown, #outputMarkdown {
            width: 90%;
            height: 200px;
            margin: 10px;
        }
    </style>
</head>
<body>

<h2>Markdown Formatter and Link Extractor</h2>
<textarea id="inputMarkdown" placeholder="输入Markdown内容..."></textarea><br>
<button onclick="formatAndExtractLinks()">格式化并提取链接</button><br>
<textarea id="outputMarkdown" readonly placeholder="处理后的结果..."></textarea>

<script>
    function formatAndExtractLinks() {
        let inputText = document.getElementById('inputMarkdown').value;
        let output = document.getElementById('outputMarkdown');
        
        // 保留代码块内容
        let codeBlocks = [];
        let codeBlockRegex = /```[\s\S]*?```/g;
        inputText = inputText.replace(codeBlockRegex, match => {
            codeBlocks.push(match);
            return '\0'; // 使用空字符作为占位符
        });

        // 自动在数字和中文、中英文之间加入空格
        inputText = inputText.replace(/([\u4e00-\u9fa5])([A-Za-z0-9])/g, '$1 $2');
        inputText = inputText.replace(/([A-Za-z0-9])([\u4e00-\u9fa5])/g, '$1 $2');

        // 转换全角括号并添加空格
        inputText = inputText.replace(/（/g, '( ');
        inputText = inputText.replace(/）/g, ' )');

        // 分段处理，以换行符分割文本
        let paragraphs = inputText.split('\n\n');
        let processedParagraphs = paragraphs.map(paragraph => {
            // 正则表达式匹配Markdown链接格式
            const linkRegex = /\[([^\]]+)\]\((https?:\/\/[^\s)]+)(?: "[^"]*")?\)/g;
            let links = [];
            let result;
            let processedText = paragraph;

            // 循环匹配并收集所有链接，跳过微信链接
            while ((result = linkRegex.exec(paragraph)) !== null) {
                if (!result[2].includes('mp.weixin.qq.com')) {
                    links.push({
                        title: result[1],
                        url: result[2]
                    });
                }
            }

            // 构建并追加链接到当前段落
            if (links.length > 0) {
                let linksString = links.map(link => `- ${link.title}\n<url>${link.url}</url>`).join('\n');
                processedText += '\n\n' + linksString; // 追加链接到当前段落下面
            }

            return processedText;
        });

        // 将处理后的段落重新拼接成一个字符串
        let formattedText = processedParagraphs.join('\n\n');

        // 恢复代码块
        formattedText = formattedText.replace(/\0/g, () => codeBlocks.shift());

        // 显示在输出框中
        output.value = formattedText;
    }
</script>

</body>
</html>
